name: Build ShadowMaster (Pro Merging Fix)

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ› ï¸ Pro Source Merging
        run: |
          echo "ğŸ§¹ Cleaning ShadowUI.m..."
          sed -i '' 's/preferredStyle:1/preferredStyle:UIAlertControllerStyleAlert/g' ShadowUI.m || true
          sed -i '' 's/style:0/style:UIAlertActionStyleDefault/g' ShadowUI.m || true
          
          echo "ğŸ§¬ Creating Header & Merging Core Logic..."
          
          # 1. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ù‡ÙŠØ¯Ø± (ÙŠØ­ÙˆÙŠ Ø§Ù„ØªØ¹Ø±ÙŠÙØ§Øª ÙÙ‚Ø· Ù„Ø­Ù„ Ø§Ù„Ù€ Duplicate)
          cat << 'EOF' > ShadowMasterCore.h
          #import <Foundation/Foundation.h>
          #import <UIKit/UIKit.h>
          #import <objc/runtime.h>
          #import <mach-o/dyld.h>

          typedef struct { float x, y, z; } PlayerData;
          typedef struct { float x, y; } AimData;
          typedef struct { float x, y, z; } MovementData;
          typedef struct { float fov; } VisionData;
          typedef struct { float gravity; } PhysicsData;
          typedef struct { float max_speed; } MoveConstraints;
          typedef struct { int count; } ShotData;

          @interface MemoryExploiter : NSObject @end
          @interface BehaviorSpoofer : NSObject @end
          @interface NetworkManipulator : NSObject @end
          @interface ServerSpoofer : NSObject @end
          @interface HardwareSpoofer : NSObject @end
          @interface AIEvader : NSObject @end

          @interface ShadowMasterCore : NSObject
          @property (strong, nonatomic) MemoryExploiter *memoryExploiter;
          @property (strong, nonatomic) BehaviorSpoofer *behaviorSpoofer;
          @property (strong, nonatomic) NetworkManipulator *networkManipulator;
          @property (strong, nonatomic) ServerSpoofer *serverSpoofer;
          @property (strong, nonatomic) HardwareSpoofer *hardwareSpoofer;
          + (instancetype)master;
          @end
          EOF

          # 2. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ¯Ù…Ø¬ Ø§Ù„Ø­Ù…Ø§ÙŠØ© (ÙŠØ­ÙˆÙŠ Ø§Ù„Ù€ Implementation)
          cat << 'EOF' > "SHADOW MASTER v11.m"
          #import "ShadowMasterCore.h"

          @implementation ShadowMasterCore
          + (instancetype)master {
              static ShadowMasterCore *instance = nil;
              static dispatch_once_t onceToken;
              dispatch_once(&onceToken, ^{
                  instance = [[self alloc] init];
              });
              return instance;
          }
          @end
          EOF
          
          # 3. Ø³ÙƒØ±ÙŠØ¨Øª Python Ù„Ø¯Ù…Ø¬ Ø§Ù„Ù€ Implementations Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø¥Ø°Ø§ ÙˆØ¬Ø¯)
          # Ù‡Ù†Ø§ Ù†Ù‚ÙˆÙ… Ø¨Ù†Ù‚Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ Ø§Ù„ÙØ¹Ù„ÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
          python3 -c "
          try:
              with open('SHADOW MASTER v11.m.bak', 'r') as f:
                  old_content = f.read()
              
              # Ù†Ù‚Ù„ Ø§Ù„Ù€ Methods Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
              with open('SHADOW MASTER v11.m', 'a') as f:
                  f.write(old_content)
          except FileNotFoundError:
              pass # Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ù‚Ø¯ÙŠÙ…
          "

          echo "ğŸ“‹ Correcting Swizzling Class Reference..."
          sed -i '' 's/Class class = \[self class\];/Class cls = \[self class\];/g' ShadowUI.m || true
          sed -i '' 's/class_getInstanceMethod(class,/class_getInstanceMethod(cls,/g' ShadowUI.m || true

      - name: ğŸš€ Build Combined Dylib (Pro Way)
        run: |
          mkdir -p output
          SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)

          clang++ -arch arm64 \
            -dynamiclib \
            -x objective-c++ \
            -std=c++17 \
            -isysroot "$SDK_PATH" \
            -miphoneos-version-min=14.0 \
            -O3 \
            -fobjc-arc \
            -w \
            -fpermissive \
            -I. \
            "SHADOW MASTER v11.m" \
            ShadowUI.m \
            -framework Foundation \
            -framework UIKit \
            -framework Security \
            -lc++ \
            -ldl \
            -o output/ShadowMaster.dylib

      - name: ğŸ›¡ï¸ Verify & Upload
        run: |
          xcrun strip -x output/ShadowMaster.dylib
          ls -lh output/
          file output/ShadowMaster.dylib

      - name: ğŸ“¦ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ShadowMaster_Pro_Build
          path: output/ShadowMaster.dylib
