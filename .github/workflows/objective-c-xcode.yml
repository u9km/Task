name: Build ShadowMaster (Fix Structure Errors)

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ§ª Advanced Source Re-Structure
        run: |
          echo "ğŸš€ Starting Advanced Patching..."
          
          # 1. Ø¥ØµÙ„Ø§Ø­ ShadowUI.m (ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¥Ù„Ù‰ Enum ÙˆØªØµØ­ÙŠØ­ keyWindow)
          sed -i '' 's/preferredStyle:1/preferredStyle:UIAlertControllerStyleAlert/g' ShadowUI.m || true
          sed -i '' 's/style:0/style:UIAlertActionStyleDefault/g' ShadowUI.m || true
          sed -i '' 's/\[UIApplication sharedApplication\]\.keyWindow/\[\[\[UIApplication sharedApplication\] windows\] firstObject\]/g' ShadowUI.m || true

          # 2. Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±ÙŠØ¨Øª Python Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¹Ù‚Ø¯ (SHADOW MASTER v11.m)
          # Ù‡Ø°Ø§ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø³ÙŠØ¶Ø¹ ÙƒÙ„ Ø§Ù„Ù€ Interfaces ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙˆØ§Ù„Ù€ Implementations ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„
          cat << 'EOF' > fix_structure.py
          import re

          def fix_file(filename):
              with open(filename, 'r') as f:
                  content = f.read()

              # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø§Øª ÙˆØ§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø§Øª
              imports = re.findall(r'#import.*', content)
              
              # Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙƒÙ„ ÙƒØªÙ„ Ø§Ù„Ù€ @interface
              interfaces = re.findall(r'@interface.*?@end', content, re.DOTALL)
              
              # Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙƒÙ„ ÙƒØªÙ„ Ø§Ù„Ù€ @implementation
              implementations = re.findall(r'@implementation.*?@end', content, re.DOTALL)
              
              # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø«Ø§Ø¨ØªØ© (ROP, Shellcode, Main)
              statics = re.findall(r'static void.*?\{.*?\}', content, re.DOTALL)
              main_func = re.findall(r'int main.*?\{.*?\}', content, re.DOTALL)
              constructor = re.findall(r'__attribute__\(\(constructor\)\).*?\{.*?\}', content, re.DOTALL)

              # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨ØªØ±ØªÙŠØ¨ ØµØ­ÙŠØ­
              new_content = "// FIXED STRUCTURE - LOGIC UNTOUCHED\n"
              new_content += "\n".join(set(imports)) + "\n\n"
              
              # Ø¥Ø¶Ø§ÙØ© ØªØ¹Ø±ÙŠÙØ§Øª Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© (Forward Declarations)
              new_content += "@class MLModel, PlayerData, AimData, MovementData, VisionData, PhysicsData, MoveConstraints, ShotData;\n"
              new_content += "@class VideoFrame, CheatPrediction, ClientState, ValidationResult, PlayerAction, CheatDetection, SecurityAlert, VulnerabilityAssessment;\n"
              new_content += "@class NetworkManipulator, ServerSpoofer, HardwareSpoofer, MemoryExploiter, BehaviorSpoofer, AIEvader, AttackerDashboard;\n\n"
              
              # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù€ Structs Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
              new_content += "typedef struct { float x, y, z; } PlayerData;\ntypedef struct { float x, y; } AimData;\ntypedef struct { float x, y, z; } MovementData;\ntypedef struct { float fov; } VisionData;\ntypedef struct { float gravity; } PhysicsData;\ntypedef struct { float max_speed; } MoveConstraints;\ntypedef struct { int count; } ShotData;\n\n"

              # ÙˆØ¶Ø¹ ÙƒÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
              for iface in interfaces:
                  # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ© Ø§Ù„Ù…ÙƒØ±Ø±Ø© (Ù…Ø«Ù„ @interface Class : NSObject @end)
                  if "NSObject @end" not in iface or len(iface) > 40:
                      new_content += iface + "\n\n"

              # ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø«Ø§Ø¨ØªØ©
              for stat in statics: new_content += stat + "\n\n"
              
              # ÙˆØ¶Ø¹ ÙƒÙ„ Ø§Ù„ØªÙ†ÙÙŠØ°Ø§Øª ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„
              for impl in implementations:
                  new_content += impl + "\n\n"

              # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù€ Constructor ÙˆØ§Ù„Ù€ Main ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
              if constructor: new_content += constructor[0] + "\n\n"
              if main_func: new_content += main_func[0] + "\n"

              with open(filename, 'w') as f:
                  f.write(new_content)

          fix_file("SHADOW MASTER v11.m")
          EOF

          python3 fix_structure.py
          echo "âœ… File Structure Re-organized."

      - name: ğŸš€ Build Combined Dylib
        run: |
          mkdir -p output
          SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)

          echo "Building for iOS arm64..."
          clang++ -arch arm64 \
            -dynamiclib \
            -x objective-c++ \
            -std=c++17 \
            -isysroot "$SDK_PATH" \
            -miphoneos-version-min=14.0 \
            -O3 \
            -fobjc-arc \
            -w \
            -fpermissive \
            -I. \
            "SHADOW MASTER v11.m" \
            ShadowUI.m \
            -framework Foundation \
            -framework UIKit \
            -framework Security \
            -framework CoreGraphics \
            -framework CoreImage \
            -framework CoreML \
            -framework QuartzCore \
            -framework Metal \
            -framework MetalKit \
            -lc++ \
            -ldl \
            -o output/ShadowMaster.dylib

      - name: ğŸ›¡ï¸ Verify & Upload
        run: |
          xcrun strip -x output/ShadowMaster.dylib
          ls -lh output/
          file output/ShadowMaster.dylib

      - name: ğŸ“¦ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ShadowMaster_Fixed
          path: output/ShadowMaster.dylib
