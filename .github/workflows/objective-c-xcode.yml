name: Build ShadowMaster Combined (Stable Fix)

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ› ï¸ Smart Patching (Fix Syntax & Logic Errors)
        run: |
          echo "ğŸ”§ Creating Header for Missing Types..."
          cat << 'EOF' > ShadowDefinitions.h
          #import <Foundation/Foundation.h>
          #import <UIKit/UIKit.h>
          #import <CoreML/CoreML.h>

          // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù‡ÙŠØ§ÙƒÙ„ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© Ù„Ø¶Ù…Ø§Ù† Ù†Ø¬Ø§Ø­ Ø§Ù„Ø±Ø¨Ø·
          typedef struct { float x, y, z; } PlayerData;
          typedef struct { float x, y; } AimData;
          typedef struct { float x, y, z; } MovementData;
          typedef struct { float fov; } VisionData;
          typedef struct { float gravity; } PhysicsData;
          typedef struct { float max_speed; } MoveConstraints;
          typedef struct { int count; } ShotData;
          
          @class MLModel, VideoFrame, CheatPrediction, ClientState, ValidationResult;
          @class PlayerAction, CheatDetection, SecurityAlert, VulnerabilityAssessment;
          @class VulnerabilityAnalysis, AttackPlan, AttackerDashboard;

          @interface AttackerDashboard : NSObject
          + (instancetype)shared;
          - (void)updateWithVulnerability:(id)vuln;
          + (void)launch;
          @end
          EOF

          echo "ğŸ©¹ Patching SHADOW MASTER v11.m..."
          # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø±ÙŠÙØ§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ø§Ù„ØªÙŠ ØªØ³Ø¨Ø¨ Ø£Ø®Ø·Ø§Ø¡ duplicate interface
          sed -i '' '/@interface.*NSObject @end/d' "SHADOW MASTER v11.m" || true
          
          # Ø­Ù‚Ù† Ù…Ù„Ù Ø§Ù„ØªØ¹Ø±ÙŠÙØ§Øª ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù
          sed -i '' '1i\
          #import "ShadowDefinitions.h"\
          ' "SHADOW MASTER v11.m" || true

          echo "ğŸ©¹ Patching ShadowUI.m..."
          # Ø¥ØµÙ„Ø§Ø­ ØªØ­Ø°ÙŠØ± keyWindow Ø§Ù„Ù‚Ø¯ÙŠÙ…
          sed -i '' 's/\[UIApplication sharedApplication\]\.keyWindow/\[\[\[UIApplication sharedApplication\] windows\] firstObject\]/g' ShadowUI.m || true

      - name: ğŸš€ Build Combined Dylib
        run: |
          mkdir -p output
          SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)

          echo "Building for iOS arm64..."
          # ØªÙ… Ø¥Ø¶Ø§ÙØ© '-x objective-c++' Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© ØªØ¹Ø§Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±
          clang++ -arch arm64 \
            -dynamiclib \
            -x objective-c++ \
            -std=c++17 \
            -isysroot "$SDK_PATH" \
            -miphoneos-version-min=14.0 \
            -O3 \
            -fobjc-arc \
            -w \
            -fpermissive \
            -I. \
            "SHADOW MASTER v11.m" \
            ShadowUI.m \
            -framework Foundation \
            -framework UIKit \
            -framework Security \
            -framework CoreGraphics \
            -framework CoreImage \
            -framework CoreML \
            -framework QuartzCore \
            -framework Metal \
            -framework MetalKit \
            -lc++ \
            -ldl \
            -o output/ShadowMaster.dylib

      - name: ğŸ›¡ï¸ Strip & Verify
        run: |
          xcrun strip -x output/ShadowMaster.dylib
          file output/ShadowMaster.dylib
          ls -lh output/

      - name: ğŸ“¦ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ShadowMaster_Final
          path: output/ShadowMaster.dylib
