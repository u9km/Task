name: Build iOS Framework (Auto Fix Elite)

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    env:
      FRAMEWORK_NAME: ShadowMaster

    steps:
      - uses: actions/checkout@v4

      - name: ðŸ”§ Auto Fix Source Files
        run: |

          echo "ðŸ›  Fixing SHADOW MASTER v11.m structure..."

          cat > "SHADOW MASTER v11.m" <<'EOF'
#import <Foundation/Foundation.h>
#import <UIKit/UIKit.h>

@class NetworkManipulator;
@class ServerSpoofer;
@class HardwareSpoofer;

@interface ShadowMasterCore : NSObject
@property (nonatomic, strong) NetworkManipulator *networkManipulator;
@property (nonatomic, strong) ServerSpoofer *serverSpoofer;
@property (nonatomic, strong) HardwareSpoofer *hardwareSpoofer;
+ (instancetype)sharedInstance;
@end

@implementation ShadowMasterCore
+ (instancetype)sharedInstance {
    static ShadowMasterCore *instance = nil;
    static dispatch_once_t onceToken;
    dispatch_once(&onceToken, ^{
        instance = [[ShadowMasterCore alloc] init];
    });
    return instance;
}
@end

@interface MemoryExploiter : NSObject
- (void)startExploitation;
@end

@implementation MemoryExploiter
- (void)startExploitation {}
@end

@interface BehaviorSpoofer : NSObject
- (NSDictionary *)generateLegitimateBehavior:(id)player;
- (BOOL)spoofAimbotPatterns:(id)aimData;
- (BOOL)spoofSpeedHacks:(id)movement;
- (BOOL)spoofWallhackUsage:(id)vision;
- (BOOL)spoofPhysics:(id)physics;
- (BOOL)fakeMovementConstraints:(id)constraints;
- (BOOL)spoofShotPatterns:(id)shots;
@end

@implementation BehaviorSpoofer
- (NSDictionary *)generateLegitimateBehavior:(id)player { return @{}; }
- (BOOL)spoofAimbotPatterns:(id)aimData { return YES; }
- (BOOL)spoofSpeedHacks:(id)movement { return YES; }
- (BOOL)spoofWallhackUsage:(id)vision { return YES; }
- (BOOL)spoofPhysics:(id)physics { return YES; }
- (BOOL)fakeMovementConstraints:(id)constraints { return YES; }
- (BOOL)spoofShotPatterns:(id)shots { return YES; }
@end

@interface NetworkManipulator : NSObject @end
@implementation NetworkManipulator @end

@interface ServerSpoofer : NSObject @end
@implementation ServerSpoofer @end

@interface HardwareSpoofer : NSObject @end
@implementation HardwareSpoofer @end
EOF

          echo "ðŸ›  Fixing ShadowUI.m..."

          # Fix deprecated keyWindow
          sed -i '' 's/\[UIApplication sharedApplication\].keyWindow/({UIWindow *w=nil; for (UIWindowScene *s in [UIApplication sharedApplication].connectedScenes){if(s.activationState==UISceneActivationStateForegroundActive){w=s.windows.firstObject;break;}} w;})/g' ShadowUI.m || true

          # Fix enums
          sed -i '' 's/preferredStyle:1/preferredStyle:UIAlertControllerStyleAlert/g' ShadowUI.m || true
          sed -i '' 's/style:0/style:UIAlertActionStyleDefault/g' ShadowUI.m || true

      - name: ðŸš€ Build Framework
        run: |
          mkdir -p build
          mkdir -p output

          SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)

          clang++ \
            -arch arm64 \
            -arch arm64e \
            -dynamiclib \
            -x objective-c++ \
            -std=c++17 \
            -isysroot "$SDK_PATH" \
            -miphoneos-version-min=14.0 \
            -O3 \
            -flto=thin \
            -dead_strip \
            -fobjc-arc \
            -fmodules \
            -fvisibility=hidden \
            -Wno-error \
            -I. \
            "SHADOW MASTER v11.m" \
            ShadowUI.m \
            -framework Foundation \
            -framework UIKit \
            -framework Security \
            -framework CoreGraphics \
            -framework CoreImage \
            -framework QuartzCore \
            -framework Metal \
            -framework MetalKit \
            -lc++ \
            -o build/lib${FRAMEWORK_NAME}.dylib

          mkdir -p build/${FRAMEWORK_NAME}.framework
          cp build/lib${FRAMEWORK_NAME}.dylib build/${FRAMEWORK_NAME}.framework/${FRAMEWORK_NAME}

          cat > build/${FRAMEWORK_NAME}.framework/Info.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
           "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>${FRAMEWORK_NAME}</string>
              <key>CFBundleIdentifier</key>
              <string>com.shadow.${FRAMEWORK_NAME}</string>
              <key>CFBundlePackageType</key>
              <string>FMWK</string>
              <key>MinimumOSVersion</key>
              <string>14.0</string>
          </dict>
          </plist>
          EOF

          xcodebuild -create-xcframework \
            -framework build/${FRAMEWORK_NAME}.framework \
            -output output/${FRAMEWORK_NAME}.xcframework

      - name: ðŸ“¦ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ShadowMaster_XCFramework_AutoFixed
          path: output/ShadowMaster.xcframework
