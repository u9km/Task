name: Build ShadowMaster (Pro Fix)

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ› ï¸ Pro Source Refactoring
        run: |
          echo "ğŸ§¹ Cleaning ShadowUI.m..."
          # Ø¥ØµÙ„Ø§Ø­ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù€ Enum Ù„Ù€ iOS 17
          sed -i '' 's/preferredStyle:1/preferredStyle:UIAlertControllerStyleAlert/g' ShadowUI.m || true
          sed -i '' 's/style:0/style:UIAlertActionStyleDefault/g' ShadowUI.m || true
          
          echo "ğŸ§¬ Restructuring SHADOW MASTER v11.m..."
          # 1. Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ Implementation Ù…ÙØªÙˆØ­ Ø¨Ø´ÙƒÙ„ ØºÙŠØ± ØµØ­ÙŠØ­
          # 2. Ø¥Ø¶Ø§ÙØ© @end Ø¨Ø¹Ø¯ ÙƒÙ„ Implementation
          
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Python Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù‡ÙŠÙƒÙ„ÙŠØ© (Ø£ÙƒØ«Ø± Ø¯Ù‚Ø© Ù…Ù† sed)
          python3 -c "
          with open('SHADOW MASTER v11.m', 'r') as f:
              content = f.read()
          
          # Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙˆØ¥ØºÙ„Ø§Ù‚Ù‡Ø§
          content = content.replace('@implementation MemoryExploiter', '@end\n@implementation MemoryExploiter')
          content = content.replace('@implementation BehaviorSpoofer', '@end\n@implementation BehaviorSpoofer')
          content = content.replace('@implementation NetworkManipulator', '@end\n@implementation NetworkManipulator')
          
          # ØªØ£ÙƒÙŠØ¯ ÙˆØ¬ÙˆØ¯ @end ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù
          if not content.strip().endswith('@end'):
              content = content.strip() + '\n@end\n'
              
          with open('SHADOW MASTER v11.m', 'w') as f:
              f.write(content)
          "

          echo "ğŸ“‹ Updating Header Definitions..."
          # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù€ Selectors Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± Ù„Ø¶Ù…Ø§Ù† ØªÙˆØ§ÙÙ‚ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª
          sed -i '' '/- (void)startExploitation;/a\
          - (void)monitorInRealTime;\
          - (void)cloakCompletely;' "SHADOW MASTER v11.m" || true

          # ØªØµØ­ÙŠØ­ Ø®Ø·Ø£ class_getInstanceMethod Ø¨ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø­Ø¬ÙˆØ²Ø© class
          sed -i '' 's/Class class = \[self class\];/Class cls = \[self class\];/g' "SHADOW MASTER v11.m" || true
          sed -i '' 's/class_getInstanceMethod(class,/class_getInstanceMethod(cls,/g' "SHADOW MASTER v11.m" || true
          sed -i '' 's/class_addMethod(class,/class_addMethod(cls,/g' "SHADOW MASTER v11.m" || true

      - name: ğŸš€ Build Combined Dylib
        run: |
          mkdir -p output
          SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)

          # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù€ dylib Ù…Ø¹ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ø§Ù… (Flags) Ø§Ù„ØµØ­ÙŠØ­Ø©
          clang++ -arch arm64 \
            -dynamiclib \
            -x objective-c++ \
            -std=c++17 \
            -isysroot "$SDK_PATH" \
            -miphoneos-version-min=14.0 \
            -O3 \
            -fobjc-arc \
            -w \
            -fpermissive \
            -I. \
            "SHADOW MASTER v11.m" \
            ShadowUI.m \
            -framework Foundation \
            -framework UIKit \
            -framework Security \
            -framework CoreGraphics \
            -framework CoreImage \
            -framework CoreML \
            -framework QuartzCore \
            -framework Metal \
            -framework MetalKit \
            -lc++ \
            -ldl \
            -o output/ShadowMaster.dylib

      - name: ğŸ›¡ï¸ Verify & Upload
        run: |
          xcrun strip -x output/ShadowMaster.dylib
          ls -lh output/
          file output/ShadowMaster.dylib

      - name: ğŸ“¦ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ShadowMaster_Pro_Build
          path: output/ShadowMaster.dylib
