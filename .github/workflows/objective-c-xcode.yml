name: Build iOS Framework (Elite)

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    env:
      FRAMEWORK_NAME: ShadowMaster

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üß∞ Setup Build Environment
        run: |
          mkdir -p build
          mkdir -p output

      - name: üöÄ Build Device Framework (arm64 + arm64e)
        run: |
          SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)

          clang++ \
            -arch arm64 \
            -arch arm64e \
            -dynamiclib \
            -x objective-c++ \
            -std=c++17 \
            -isysroot "$SDK_PATH" \
            -miphoneos-version-min=14.0 \
            -O3 \
            -flto=thin \
            -dead_strip \
            -fobjc-arc \
            -fmodules \
            -fvisibility=hidden \
            -fvisibility-inlines-hidden \
            -Werror \
            -Wall \
            -I. \
            "SHADOW MASTER v11.m" \
            ShadowUI.m \
            -framework Foundation \
            -framework UIKit \
            -framework Security \
            -framework CoreGraphics \
            -framework CoreImage \
            -framework CoreML \
            -framework QuartzCore \
            -framework Metal \
            -framework MetalKit \
            -lc++ \
            -o build/lib${FRAMEWORK_NAME}.dylib

      - name: üì¶ Create Framework Structure
        run: |
          mkdir -p build/${FRAMEWORK_NAME}.framework
          cp build/lib${FRAMEWORK_NAME}.dylib build/${FRAMEWORK_NAME}.framework/${FRAMEWORK_NAME}

          # Basic Info.plist
          cat > build/${FRAMEWORK_NAME}.framework/Info.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
           "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleDevelopmentRegion</key>
              <string>en</string>
              <key>CFBundleExecutable</key>
              <string>${FRAMEWORK_NAME}</string>
              <key>CFBundleIdentifier</key>
              <string>com.yourcompany.${FRAMEWORK_NAME}</string>
              <key>CFBundleInfoDictionaryVersion</key>
              <string>6.0</string>
              <key>CFBundleName</key>
              <string>${FRAMEWORK_NAME}</string>
              <key>CFBundlePackageType</key>
              <string>FMWK</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0</string>
              <key>CFBundleVersion</key>
              <string>1</string>
              <key>MinimumOSVersion</key>
              <string>14.0</string>
          </dict>
          </plist>
          EOF

      - name: üß© Create XCFramework
        run: |
          xcodebuild -create-xcframework \
            -framework build/${FRAMEWORK_NAME}.framework \
            -output output/${FRAMEWORK_NAME}.xcframework

      - name: üõ°Ô∏è Strip Symbols
        run: |
          find output -type f -perm +111 -exec xcrun strip -x {} \;

      - name: üîç Verify Build
        run: |
          echo "üìÅ Output:"
          ls -lh output/
          file output/${FRAMEWORK_NAME}.xcframework/**/${FRAMEWORK_NAME}

      - name: üì¶ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${FRAMEWORK_NAME}_XCFramework_Elite
          path: output/${FRAMEWORK_NAME}.xcframework
