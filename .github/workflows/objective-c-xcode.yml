name: Build iOS Framework (Pro Fix)

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    env:
      FRAMEWORK_NAME: ShadowMaster

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ”§ Fix Broken Source (Pro Way)
        run: |
          # 1. Ø¥ØµÙ„Ø§Ø­ ØªÙƒØ±Ø§Ø± Ø§Ù„ØªØ¹Ø±ÙŠÙØ§Øª ÙÙŠ SHADOW MASTER v11.m
          sed -i '' '/@implementation MemoryExploiter/,/@end/d' "SHADOW MASTER v11.m" || true
          sed -i '' '/@implementation BehaviorSpoofer/,/@end/d' "SHADOW MASTER v11.m" || true
          # Ø£Ø¶Ù Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù€ implementations Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
          
          # 2. Ø¥ØµÙ„Ø§Ø­ Swizzling Class Reference (Ø®Ø·Ø£ ÙƒÙ„Ø§Ø³ Ù…Ø­Ø¬ÙˆØ²)
          sed -i '' 's/Class class = \[self class\];/Class cls = \[self class\];/g' "SHADOW MASTER v11.m" || true
          sed -i '' 's/class_getInstanceMethod(class,/class_getInstanceMethod(cls,/g' "SHADOW MASTER v11.m" || true

          # 3. Fix enums in ShadowUI
          sed -i '' 's/preferredStyle:1/preferredStyle:UIAlertControllerStyleAlert/g' ShadowUI.m || true
          sed -i '' 's/style:0/style:UIAlertActionStyleDefault/g' ShadowUI.m || true

      - name: ğŸš€ Build Framework
        run: |
          mkdir -p build

          SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)

          clang++ \
            -arch arm64 \
            -dynamiclib \
            -x objective-c++ \
            -std=c++17 \
            -isysroot "$SDK_PATH" \
            -miphoneos-version-min=14.0 \
            -O3 \
            -fobjc-arc \
            -Wno-error \
            "SHADOW MASTER v11.m" \
            ShadowUI.m \
            -framework Foundation \
            -framework UIKit \
            -framework Security \
            -lc++ \
            -o build/lib${FRAMEWORK_NAME}.dylib

      - name: ğŸ“¦ Upload
        uses: actions/upload-artifact@v4
        with:
          name: ShadowMaster_Framework
          path: build/libShadowMaster.dylib
