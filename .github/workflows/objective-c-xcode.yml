name: Build Real iOS Framework

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    env:
      FRAMEWORK_NAME: ShadowMaster

    steps:
      - uses: actions/checkout@v4

      - name: üìÅ Prepare Structure
        run: |
          mkdir -p build
          mkdir -p build/${FRAMEWORK_NAME}.framework
          mkdir -p build/${FRAMEWORK_NAME}.framework/Headers
          mkdir -p build/${FRAMEWORK_NAME}.framework/Modules
          mkdir -p output

      - name: üßæ Generate Public Header
        run: |
          echo '#import <Foundation/Foundation.h>' > build/${FRAMEWORK_NAME}.framework/Headers/${FRAMEWORK_NAME}.h
          echo '@interface ShadowMasterCore : NSObject' >> build/${FRAMEWORK_NAME}.framework/Headers/${FRAMEWORK_NAME}.h
          echo '+ (instancetype)sharedInstance;' >> build/${FRAMEWORK_NAME}.framework/Headers/${FRAMEWORK_NAME}.h
          echo '@end' >> build/${FRAMEWORK_NAME}.framework/Headers/${FRAMEWORK_NAME}.h

      - name: üß© Generate module.modulemap
        run: |
          echo "framework module ${FRAMEWORK_NAME} {" > build/${FRAMEWORK_NAME}.framework/Modules/module.modulemap
          echo "  umbrella header \"${FRAMEWORK_NAME}.h\"" >> build/${FRAMEWORK_NAME}.framework/Modules/module.modulemap
          echo "  export *" >> build/${FRAMEWORK_NAME}.framework/Modules/module.modulemap
          echo "  module * { export * }" >> build/${FRAMEWORK_NAME}.framework/Modules/module.modulemap
          echo "}" >> build/${FRAMEWORK_NAME}.framework/Modules/module.modulemap

      - name: üöÄ Build Binary
        run: |
          SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)

          clang++ \
            -arch arm64 \
            -arch arm64e \
            -dynamiclib \
            -install_name @rpath/${FRAMEWORK_NAME}.framework/${FRAMEWORK_NAME} \
            -x objective-c++ \
            -std=c++17 \
            -isysroot "$SDK_PATH" \
            -miphoneos-version-min=14.0 \
            -O2 \
            -fobjc-arc \
            -fmodules \
            -Wno-error \
            "SHADOW MASTER v11.m" \
            ShadowUI.m \
            -framework Foundation \
            -framework UIKit \
            -lc++ \
            -o build/${FRAMEWORK_NAME}.framework/${FRAMEWORK_NAME}

      - name: üßæ Generate Info.plist
        run: |
          cat > build/${FRAMEWORK_NAME}.framework/Info.plist <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
"http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>CFBundleExecutable</key>
  <string>${FRAMEWORK_NAME}</string>
  <key>CFBundleIdentifier</key>
  <string>com.shadow.${FRAMEWORK_NAME}</string>
  <key>CFBundlePackageType</key>
  <string>FMWK</string>
  <key>MinimumOSVersion</key>
  <string>14.0</string>
</dict>
</plist>
EOF

      - name: üì¶ Create XCFramework
        run: |
          xcodebuild -create-xcframework \
            -framework build/${FRAMEWORK_NAME}.framework \
            -output output/${FRAMEWORK_NAME}.xcframework

      - name: üì§ Upload
        uses: actions/upload-artifact@v4
        with:
          name: ShadowMaster_Real_Framework
          path: output/${FRAMEWORK_NAME}.xcframework
