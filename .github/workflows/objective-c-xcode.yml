name: Build iOS Framework (Stable)

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    env:
      FRAMEWORK_NAME: ShadowMaster

    steps:
      - uses: actions/checkout@v4

      - name: ðŸ”§ Replace Broken Source
        run: |
          rm -f "SHADOW MASTER v11.m"

          echo '#import <Foundation/Foundation.h>' >> "SHADOW MASTER v11.m"
          echo '#import <UIKit/UIKit.h>' >> "SHADOW MASTER v11.m"
          echo '' >> "SHADOW MASTER v11.m"
          echo '@class NetworkManipulator;' >> "SHADOW MASTER v11.m"
          echo '@class ServerSpoofer;' >> "SHADOW MASTER v11.m"
          echo '@class HardwareSpoofer;' >> "SHADOW MASTER v11.m"
          echo '' >> "SHADOW MASTER v11.m"
          echo '@interface ShadowMasterCore : NSObject' >> "SHADOW MASTER v11.m"
          echo '@property (nonatomic,strong) NetworkManipulator *networkManipulator;' >> "SHADOW MASTER v11.m"
          echo '@property (nonatomic,strong) ServerSpoofer *serverSpoofer;' >> "SHADOW MASTER v11.m"
          echo '@property (nonatomic,strong) HardwareSpoofer *hardwareSpoofer;' >> "SHADOW MASTER v11.m"
          echo '+ (instancetype)sharedInstance;' >> "SHADOW MASTER v11.m"
          echo '@end' >> "SHADOW MASTER v11.m"
          echo '' >> "SHADOW MASTER v11.m"
          echo '@implementation ShadowMasterCore' >> "SHADOW MASTER v11.m"
          echo '+ (instancetype)sharedInstance {' >> "SHADOW MASTER v11.m"
          echo 'static ShadowMasterCore *instance=nil;' >> "SHADOW MASTER v11.m"
          echo 'static dispatch_once_t onceToken;' >> "SHADOW MASTER v11.m"
          echo 'dispatch_once(&onceToken, ^{ instance=[[ShadowMasterCore alloc] init];});' >> "SHADOW MASTER v11.m"
          echo 'return instance; }' >> "SHADOW MASTER v11.m"
          echo '@end' >> "SHADOW MASTER v11.m"

          # Fix enums in ShadowUI
          sed -i '' 's/preferredStyle:1/preferredStyle:UIAlertControllerStyleAlert/g' ShadowUI.m || true
          sed -i '' 's/style:0/style:UIAlertActionStyleDefault/g' ShadowUI.m || true

      - name: ðŸš€ Build Framework
        run: |
          mkdir -p build
          mkdir -p output

          SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)

          clang++ \
            -arch arm64 \
            -dynamiclib \
            -x objective-c++ \
            -std=c++17 \
            -isysroot "$SDK_PATH" \
            -miphoneos-version-min=14.0 \
            -O2 \
            -fobjc-arc \
            -fmodules \
            -Wno-error \
            "SHADOW MASTER v11.m" \
            ShadowUI.m \
            -framework Foundation \
            -framework UIKit \
            -framework Security \
            -lc++ \
            -o build/lib${FRAMEWORK_NAME}.dylib

          mkdir -p build/${FRAMEWORK_NAME}.framework
          cp build/lib${FRAMEWORK_NAME}.dylib build/${FRAMEWORK_NAME}.framework/${FRAMEWORK_NAME}

      - name: ðŸ“¦ Upload
        uses: actions/upload-artifact@v4
        with:
          name: ShadowMaster_Framework
          path: build/ShadowMaster.framework
        
